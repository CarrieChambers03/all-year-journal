const Ajv = require("ajv");
const ajv = new Ajv();
const tetrisDao = require('../../dao/tetris-dao.js');

const schema = {
    type: "object",
    properties: {
        title: { type: "string" },
        shapes: { type: "object", properties: {
            Z: { type: "string" },
            W: { type: "string" },
            I: { type: "string" },
            L: { type: "string" },
            O: { type: "string" },
            T: { type: "string" },
            J: { type: "string" },
            D: { type: "string" }
        } }
    },
    required: ["title", "shapes"],
    additionalProperties: false
}

function createAbl (req, res) {
    try {
        const valid = ajv.validate(schema, req.body);
        if (!valid) {
            return res.status(400).json(ajv.errors);
        }

        const tetris = req.body;
        tetris.year = new Date().getFullYear();
        tetris.table = {
            1: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            2: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            3: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            4: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            5: {1: "", 
                2: "", 
                3: "", 
                4: "", 
                5: "", 
                6: "", 
                7: "", 
                8: "", 
                9: "", 
                10: "", 
                11: "", 
                12: "", 
                13: "", 
                14: "", 
                15: "", 
                16: "", 
                17: "", 
                18: "", 
                19: "", 
                20: "", 
                21: "", 
                22: "", 
                23: "", 
                24: "", 
                25: "", 
                26: "", 
                27: "", 
                28: "", 
                29: "", 
                30: ""},
            6: {1: "", 
                2: "", 
                3: "", 
                4: "", 
                5: "", 
                6: "", 
                7: "", 
                8: "", 
                9: "", 
                10: "", 
                11: "", 
                12: "", 
                13: "", 
                14: "", 
                15: "", 
                16: "", 
                17: "", 
                18: "", 
                19: "", 
                20: "", 
                21: "", 
                22: "", 
                23: "", 
                24: "", 
                25: "", 
                26: "", 
                27: "", 
                28: "", 
                29: "", 
                30: ""},
            7: {1: "", 
                2: "", 
                3: "", 
                4: "", 
                5: "", 
                6: "", 
                7: "", 
                8: "", 
                9: "", 
                10: "", 
                11: "", 
                12: "", 
                13: "", 
                14: "", 
                15: "", 
                16: "", 
                17: "", 
                18: "", 
                19: "", 
                20: "", 
                21: "", 
                22: "", 
                23: "", 
                24: "", 
                25: "", 
                26: "", 
                27: "", 
                28: "", 
                29: "", 
                30: ""},
            8: {1: "", 
                2: "", 
                3: "", 
                4: "", 
                5: "", 
                6: "", 
                7: "", 
                8: "", 
                9: "", 
                10: "", 
                11: "", 
                12: "", 
                13: "", 
                14: "", 
                15: "", 
                16: "", 
                17: "", 
                18: "", 
                19: "", 
                20: "", 
                21: "", 
                22: "", 
                23: "", 
                24: "", 
                25: "", 
                26: "", 
                27: "", 
                28: "", 
                29: "", 
                30: ""},
            9: {1: "", 
                2: "", 
                3: "", 
                4: "", 
                5: "", 
                6: "", 
                7: "", 
                8: "", 
                9: "", 
                10: "", 
                11: "", 
                12: "", 
                13: "", 
                14: "", 
                15: "", 
                16: "", 
                17: "", 
                18: "", 
                19: "", 
                20: "", 
                21: "", 
                22: "", 
                23: "", 
                24: "", 
                25: "", 
                26: "", 
                27: "", 
                28: "", 
                29: "", 
                30: ""}, 
            10: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            11: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            12: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""},
            13: {1: "",
                2: "",
                3: "",
                4: "",
                5: "",
                6: "",
                7: "",
                8: "",
                9: "",
                10: "",
                11: "",
                12: "",
                13: "",
                14: "",
                15: "",
                16: "",
                17: "",
                18: "",
                19: "",
                20: "",
                21: "",
                22: "",
                23: "",
                24: "",
                25: "",
                26: "",
                27: "",
                28: "",
                29: "",
                30: ""}
        }

        const created = tetrisDao.create(tetris);
        if (!created) {
            return res.status(500).json({ message: "Failed to create sheet" });
        }

        return res.status(201).json({ message: "Sheet created" });
    } catch (e) {
        return res.status(500).json({ message: e.message });
    }
}

module.exports = createAbl;